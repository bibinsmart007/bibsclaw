<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibsClaw AI Assistant</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-card: rgba(17, 24, 39, 0.8);
            --border: rgba(99, 102, 241, 0.15);
            --border-active: rgba(99, 102, 241, 0.4);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --user-msg: linear-gradient(135deg, #6366f1, #8b5cf6);
            --assistant-msg: rgba(30, 41, 59, 0.8);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); height: 100vh; display: flex; overflow: hidden; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-active); }
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: width 0.3s ease; flex-shrink: 0; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-header { padding: 20px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
        .logo { width: 36px; height: 36px; background: var(--user-msg); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; flex-shrink: 0; }
        .sidebar-header h1 { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #6366f1, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; white-space: nowrap; }
        .sidebar.collapsed .sidebar-header h1, .sidebar.collapsed .nav-label, .sidebar.collapsed .sidebar-footer span { display: none; }
        .nav { flex: 1; padding: 12px 8px; display: flex; flex-direction: column; gap: 2px; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; font-size: 14px; text-decoration: none; white-space: nowrap; }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: rgba(99, 102, 241, 0.12); color: var(--accent); }
        .nav-item .material-icons-round { font-size: 20px; flex-shrink: 0; }
        .sidebar-footer { padding: 12px 8px; border-top: 1px solid var(--border); }
        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .topbar { height: 56px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; flex-shrink: 0; }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        .topbar-right { display: flex; align-items: center; gap: 8px; }
        .status-pill { display: flex; align-items: center; gap: 6px; padding: 4px 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--success); }
        .status-dot.offline { background: var(--danger); }
        .provider-badge { padding: 4px 10px; background: var(--user-msg); border-radius: 6px; font-size: 11px; font-weight: 600; letter-spacing: 0.5px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .icon-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); border-color: var(--border-active); }
        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .welcome-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; padding: 40px; text-align: center; }
        .welcome-icon { width: 72px; height: 72px; background: var(--user-msg); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 36px; box-shadow: 0 8px 32px var(--accent-glow); }
        .welcome-screen h2 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #f1f5f9, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .welcome-screen p { color: var(--text-secondary); font-size: 15px; line-height: 1.6; max-width: 440px; }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 8px; }
        .quick-action { padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 20px; color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .quick-action:hover { border-color: var(--accent); color: var(--accent); background: rgba(99,102,241,0.08); }
        /* Messages */
        .msg { max-width: 75%; animation: msgIn 0.3s ease; }
        .msg.user { align-self: flex-end; }
        .msg.assistant { align-self: flex-start; }
        .msg-bubble { padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .msg.user .msg-bubble { background: var(--user-msg); color: white; border-bottom-right-radius: 4px; }
        .msg.assistant .msg-bubble { background: var(--assistant-msg); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .msg.tool .msg-bubble { background: rgba(99,102,241,0.06); border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted); border-radius: 8px; }
        .msg.system .msg-bubble { background: var(--bg-tertiary); border: 1px dashed var(--border); color: var(--text-muted); text-align: center; font-size: 13px; border-radius: 8px; max-width: 100%; }
        .msg-time { font-size: 11px; color: var(--text-muted); margin-top: 4px; padding: 0 4px; }
        .msg.user .msg-time { text-align: right; }
        @keyframes msgIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        /* Thinking */
        .thinking { display: none; padding: 8px 24px; color: var(--accent); font-size: 13px; align-items: center; gap: 8px; }
        .thinking.visible { display: flex; }
        .dot-pulse { display: flex; gap: 4px; }
        .dot-pulse span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: dotPulse 1.4s infinite; }
        .dot-pulse span:nth-child(2) { animation-delay: 0.2s; }
        .dot-pulse span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotPulse { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }
        /* Input Area */
        .input-area { padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); }
        .input-wrapper { display: flex; align-items: center; gap: 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px; padding: 4px 4px 4px 16px; transition: border-color 0.2s; }
        .input-wrapper:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .input-wrapper input { flex: 1; background: none; border: none; color: var(--text-primary); font-size: 14px; outline: none; font-family: inherit; }
        .input-wrapper input::placeholder { color: var(--text-muted); }
        .btn-voice { width: 36px; height: 36px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-voice:hover { color: var(--accent); background: rgba(99,102,241,0.1); }
        .btn-voice.recording { color: var(--danger); background: rgba(239,68,68,0.1); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        .btn-send { height: 36px; padding: 0 20px; border-radius: 8px; border: none; background: var(--user-msg); color: white; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .btn-send:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        /* Right Panel */
        .right-panel { width: 280px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .panel-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .panel-tabs { display: flex; gap: 0; }
        .panel-tab { flex: 1; padding: 8px; text-align: center; font-size: 12px; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .panel-content { flex: 1; overflow-y: auto; padding: 12px; }
        .task-card { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; }
        .task-card .task-name { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .task-card .task-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .tool-entry { padding: 6px 8px; font-size: 12px; color: var(--text-muted); border-left: 2px solid var(--border); margin-bottom: 6px; margin-left: 4px; }
        .tool-entry.success { border-left-color: var(--success); }
        .tool-entry.fail { border-left-color: var(--danger); }
        .empty-state { text-align: center; padding: 32px 16px; color: var(--text-muted); font-size: 13px; }
        /* Responsive */
        @media (max-width: 768px) { .sidebar { position: fixed; left: -260px; z-index: 100; height: 100vh; } .sidebar.open { left: 0; } .right-panel { display: none; } }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">BC</div>
            <h1>BibsClaw</h1>
        </div>
        <nav class="nav">
            <a class="nav-item active" data-view="chat"><span class="material-icons-round">chat</span><span class="nav-label">Chat</span></a>
            <a class="nav-item" data-view="analytics"><span class="material-icons-round">analytics</span><span class="nav-label">Analytics</span></a>
            <a class="nav-item" data-view="tasks"><span class="material-icons-round">task_alt</span><span class="nav-label">Tasks</span></a>
            <a class="nav-item" data-view="files"><span class="material-icons-round">folder</span><span class="nav-label">Files</span></a>
            <a class="nav-item" data-view="terminal"><span class="material-icons-round">terminal</span><span class="nav-label">Terminal</span></a>
            <a class="nav-item" data-view="health"><span class="material-icons-round">monitor_heart</span><span class="nav-label">Health</span></a>
        </nav>
        <div class="sidebar-footer">
            <a class="nav-item" data-view="settings"><span class="material-icons-round">settings</span><span class="nav-label">Settings</span></a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main">
        <!-- Top Bar -->
        <header class="topbar">
            <div class="topbar-left">
                <button class="icon-btn" id="sidebarToggle"><span class="material-icons-round" style="font-size:20px">menu</span></button>
                <span id="providerBadge" class="provider-badge">PERPLEXITY</span>
            </div>
            <div class="topbar-right">
                <div class="status-pill">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
                <button class="icon-btn" id="clearBtn" title="Clear chat"><span class="material-icons-round" style="font-size:18px">delete_outline</span></button>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="messages" id="messages">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon"><span class="material-icons-round" style="font-size:36px">auto_awesome</span></div>
                    <h2>Welcome to BibsClaw</h2>
                    <p>Your personal AI assistant powered by Perplexity. Ask anything, automate tasks, or use voice commands.</p>
                    <div class="quick-actions">
                        <button class="quick-action" onclick="quickSend('What can you do?')">What can you do?</button>
                        <button class="quick-action" onclick="quickSend('Show system health')">System Health</button>
                        <button class="quick-action" onclick="quickSend('List scheduled tasks')">View Tasks</button>
                        <button class="quick-action" onclick="quickSend('Help me write code')">Code Help</button>
                    </div>
                </div>
            </div>

            <div class="thinking" id="thinking">
                <div class="dot-pulse"><span></span><span></span><span></span></div>
                <span id="thinkingText">Thinking...</span>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="messageInput" placeholder="Ask BibsClaw anything..." autocomplete="off">
                    <button class="btn-voice" id="voiceBtn" title="Voice input"><span class="material-icons-round" style="font-size:20px">mic</span></button>
                    <button class="btn-send" id="sendBtn"><span class="material-icons-round" style="font-size:18px">send</span> Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel -->
    <aside class="right-panel">
        <div class="panel-tabs">
            <div class="panel-tab active" data-panel="tasks">Tasks</div>
            <div class="panel-tab" data-panel="tools">Tools</div>
        </div>
        <div class="panel-content">
            <div id="taskPanel">
                <div class="empty-state" id="taskList"><span class="material-icons-round" style="font-size:32px;display:block;margin-bottom:8px;opacity:0.3">event_note</span>No scheduled tasks</div>
            </div>
            <div id="toolPanel" style="display:none">
                <div class="empty-state" id="toolLog"><span class="material-icons-round" style="font-size:32px;display:block;margin-bottom:8px;opacity:0.3">build</span>No tool activity</div>
            </div>
        </div>
    </aside>

    <script>
    // Socket.IO
    const socket = io({ reconnection: true, reconnectionAttempts: 10, reconnectionDelay: 1000 });
    const $ = id => document.getElementById(id);
    const messages = $('messages'), input = $('messageInput'), sendBtn = $('sendBtn');
    const voiceBtn = $('voiceBtn'), clearBtn = $('clearBtn'), thinking = $('thinking');
    const thinkingText = $('thinkingText'), statusDot = $('statusDot'), statusText = $('statusText');
    const providerBadge = $('providerBadge'), taskList = $('taskList'), toolLog = $('toolLog');

    function addMessage(role, text) {
        const ws = $('welcomeScreen'); if (ws) ws.remove();
        const div = document.createElement('div');
        div.className = 'msg ' + role;
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        bubble.textContent = text;
        div.appendChild(bubble);
        const time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        div.appendChild(time);
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    function quickSend(msg) { input.value = msg; sendMessage(); }

    function sendMessage() {
        const msg = input.value.trim();
        if (!msg) return;
        addMessage('user', msg);
        input.value = '';
        sendBtn.disabled = true;
        thinkingText.textContent = 'Thinking...';
        thinking.classList.add('visible');
        socket.emit('chat', msg);
    }

    input.addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
    sendBtn.addEventListener('click', sendMessage);
    clearBtn.addEventListener('click', () => {
        fetch('/api/history/clear', { method: 'POST' }).then(() => {
            messages.innerHTML = '';
            addMessage('system', 'Conversation cleared');
        });
    });

        // Voice - Enhanced with proper mic permission and auto-restart
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null, isListening = false;
        let voiceTimeout = null;
        if (SR) {
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('recording');
                input.placeholder = 'Listening... Speak now';
                console.log('[Voice] Started');
            };
            recognition.onresult = (e) => {
                let interim = '';
                let finalT = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const t = e.results[i][0].transcript;
                    if (e.results[i].isFinal) { finalT += t; }
                    else { interim += t; }
                }
                if (finalT) {
                    input.value = finalT;
                    clearTimeout(voiceTimeout);
                    voiceTimeout = setTimeout(() => {
                        if (input.value.trim()) { stopVoice(); sendMessage(); }
                    }, 800);
                } else if (interim) {
                    input.value = interim;
                }
            };
            recognition.onerror = (e) => {
                console.log('[Voice] Error:', e.error);
                if (e.error === 'not-allowed' || e.error === 'permission-denied') {
                    stopVoice();
                    addMessage('system','Microphone access denied. Allow mic in browser settings.');
                } else if (e.error === 'no-speech') {
                    input.placeholder = 'No speech heard. Try again...';
                } else if (e.error === 'audio-capture') {
                    stopVoice();
                    addMessage('system','No microphone found. Connect a mic and retry.');
                } else if (e.error === 'network') {
                    stopVoice();
                    addMessage('system','Network error in voice recognition.');
                } else if (e.error !== 'aborted') {
                    addMessage('system','Voice error: ' + e.error);
                }
            };
            recognition.onend = () => {
                console.log('[Voice] Ended, listening:', isListening);
                if (isListening) {
                    try { recognition.start(); }
                    catch(e) { console.log('[Voice] Restart failed:', e); stopVoice(); }
                }
            };
        }
        function stopVoice() {
            isListening = false;
            voiceBtn.classList.remove('recording');
            input.placeholder = 'Ask BibsClaw anything...';
            clearTimeout(voiceTimeout);
            try { if(recognition) recognition.stop(); } catch(e) {}
        }
        function startVoice() {
            if (!SR) { addMessage('system','Speech recognition not supported. Use Chrome/Edge.'); return; }
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(s => {
                    s.getTracks().forEach(t => t.stop());
                    isListening = true;
                    input.value = '';
                    try { recognition.start(); }
                    catch(e) { recognition.stop(); setTimeout(() => recognition.start(), 200); }
                })
                .catch(() => addMessage('system','Mic access denied. Allow mic permission and retry.'));
        }
        voiceBtn.addEventListener('click', () => {
            isListening ? stopVoice() : startVoice();
        });

    // Socket events
    socket.on('response', t => { addMessage('assistant', t); sendBtn.disabled = false; thinking.classList.remove('visible'); });
    socket.on('thinking', v => { if(v){thinking.classList.add('visible')}else{thinking.classList.remove('visible');sendBtn.disabled=false;} });
    socket.on('agentThinking', t => { thinkingText.textContent = t; thinking.classList.add('visible'); });
    socket.on('error', e => { addMessage('system','Error: '+e); sendBtn.disabled=false; thinking.classList.remove('visible'); });
    socket.on('tts_audio', b64 => { try{new Audio('data:audio/mpeg;base64,'+b64).play().catch(()=>{})}catch(e){} });
    socket.on('toolCall', d => {
        const el = document.createElement('div'); el.className='tool-entry'; el.textContent='> '+d.name;
        if(toolLog.querySelector('.empty-state')) toolLog.innerHTML='';
        toolLog.prepend(el);
    });
    socket.on('toolResult', d => {
        const el = document.createElement('div'); el.className='tool-entry '+(d.result.success?'success':'fail');
        el.textContent=d.name+': '+(d.result.success?'OK':'FAIL');
        toolLog.prepend(el);
    });
    socket.on('taskRun', t => {
        const el = document.createElement('div'); el.className='tool-entry success'; el.textContent='Task: '+t.name;
        toolLog.prepend(el);
    });
    socket.on('connected', d => { providerBadge.textContent = (d.provider||'AI').toUpperCase(); });
    socket.on('disconnect', () => { statusDot.classList.add('offline'); statusText.textContent = 'Disconnected'; });
    socket.on('connect', () => {
        statusDot.classList.remove('offline'); statusText.textContent = 'Connected';
        fetch('/api/tasks').then(r=>r.json()).then(tasks => {
            if(!tasks.length) return;
            taskList.innerHTML='';
            tasks.forEach(t => { const d=document.createElement('div');d.className='task-card';d.innerHTML='<div class="task-name">'+t.name+'</div><div class="task-meta">'+t.cronExpression+' | Runs: '+t.runCount+'</div>';taskList.appendChild(d);});
        }).catch(()=>{});
    });

    // Sidebar toggle
    $('sidebarToggle').addEventListener('click', () => { $('sidebar').classList.toggle('collapsed'); $('sidebar').classList.toggle('open'); });

    // Panel tabs
    document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.panel-tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            $('taskPanel').style.display = tab.dataset.panel==='tasks'?'block':'none';
            $('toolPanel').style.display = tab.dataset.panel==='tools'?'block':'none';
        });
    });
    </script>
</body>
</html>
