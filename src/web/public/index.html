<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BibsClaw Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; height: 100vh; display: flex; flex-direction: column; }
    header { background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 20px; color: #58a6ff; }
    header .status { display: flex; gap: 12px; font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
    .status-dot.active { background: #3fb950; }
    .status-dot.inactive { background: #484f58; }
    main { flex: 1; display: flex; overflow: hidden; }
    .chat-panel { flex: 1; display: flex; flex-direction: column; }
    .sidebar { width: 300px; background: #161b22; border-left: 1px solid #30363d; padding: 16px; overflow-y: auto; }
    .sidebar h3 { color: #8b949e; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .messages { flex: 1; overflow-y: auto; padding: 16px 24px; }
    .message { margin-bottom: 16px; padding: 12px 16px; border-radius: 8px; max-width: 85%; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; font-size: 14px; }
    .message.user { background: #1f6feb; color: #fff; margin-left: auto; }
    .message.assistant { background: #21262d; border: 1px solid #30363d; }
    .message.tool { background: #0d1117; border: 1px solid #30363d; font-family: monospace; font-size: 12px; color: #8b949e; }
    .thinking { color: #8b949e; font-style: italic; padding: 8px 24px; font-size: 13px; }
    .input-area { padding: 16px 24px; background: #161b22; border-top: 1px solid #30363d; display: flex; gap: 8px; }
    .input-area input { flex: 1; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 10px 16px; border-radius: 6px; font-size: 14px; outline: none; }
    .input-area input:focus { border-color: #58a6ff; }
    .input-area button { background: #238636; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
    .input-area button:hover { background: #2ea043; }
    .input-area button:disabled { background: #21262d; cursor: not-allowed; }
    .task-item { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
    .task-item .name { color: #58a6ff; font-weight: 600; }
    .task-item .meta { color: #8b949e; font-size: 11px; margin-top: 4px; }
  </style>
</head>
<body>
  <header>
    <h1>BibsClaw</h1>
    <div class="status">
      <span><span class="status-dot active" id="statusDot"></span><span id="statusText">Connected</span></span>
    </div>
  </header>
  <main>
    <div class="chat-panel">
      <div class="messages" id="messages"></div>
      <div class="thinking" id="thinking" style="display:none">Thinking...</div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type a message or command..." autocomplete="off">
        <button id="sendBtn" onclick="sendMessage()">Send</button>
      </div>
    </div>
    <div class="sidebar">
      <h3>Scheduled Tasks</h3>
      <div id="taskList"><p style="color:#484f58;font-size:13px">No tasks yet</p></div>
      <h3 style="margin-top:24px">Tool Activity</h3>
      <div id="toolLog"></div>
    </div>
  </main>
  <script>
    const socket = io();
    const messagesDiv = document.getElementById('messages');
    const thinkingDiv = document.getElementById('thinking');
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const taskList = document.getElementById('taskList');
    const toolLog = document.getElementById('toolLog');

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = 'message ' + role;
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      addMessage('user', msg);
      input.value = '';
      sendBtn.disabled = true;
      socket.emit('chat', msg);
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    socket.on('response', (text) => {
      addMessage('assistant', text);
      sendBtn.disabled = false;
    });

    socket.on('thinking', (isThinking) => {
      thinkingDiv.style.display = isThinking ? 'block' : 'none';
    });

    socket.on('agentThinking', (text) => {
      thinkingDiv.textContent = text;
      thinkingDiv.style.display = 'block';
    });

    socket.on('toolCall', (data) => {
      const div = document.createElement('div');
      div.className = 'message tool';
      div.textContent = 'Tool: ' + data.name;
      toolLog.prepend(div);
    });

    socket.on('toolResult', (data) => {
      const div = document.createElement('div');
      div.className = 'message tool';
      div.textContent = data.name + ': ' + (data.result.success ? 'OK' : 'FAIL');
      toolLog.prepend(div);
    });

    socket.on('taskRun', (task) => {
      const div = document.createElement('div');
      div.className = 'message tool';
      div.textContent = 'Task ran: ' + task.name;
      toolLog.prepend(div);
    });

    socket.on('disconnect', () => {
      statusDot.className = 'status-dot inactive';
      statusText.textContent = 'Disconnected';
    });

    socket.on('connect', () => {
      statusDot.className = 'status-dot active';
      statusText.textContent = 'Connected';
      fetch('/api/tasks').then(r => r.json()).then(tasks => {
        if (tasks.length === 0) return;
        taskList.innerHTML = '';
        tasks.forEach(t => {
          const div = document.createElement('div');
          div.className = 'task-item';
          div.innerHTML = '<div class="name">' + t.name + '</div><div class="meta">' + t.cronExpression + ' | Runs: ' + t.runCount + '</div>';
          taskList.appendChild(div);
        });
      });
    });
  </script>
</body>
</html>
