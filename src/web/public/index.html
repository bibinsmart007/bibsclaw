<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BibsClaw Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #c9d1d9; height: 100vh; display: flex; flex-direction: column; }
        header { background: #161b22; border-bottom: 1px solid #30363d; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; }
        header h1 { font-size: 20px; color: #58a6ff; }
        header .status { display: flex; gap: 12px; font-size: 13px; align-items: center; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-dot.active { background: #3fb950; }
        .status-dot.inactive { background: #f85149; }
        .provider-badge { background: #1f6feb; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
        main { flex: 1; display: flex; overflow: hidden; }
        .chat-panel { flex: 1; display: flex; flex-direction: column; }
        .sidebar { width: 300px; background: #161b22; border-left: 1px solid #30363d; padding: 16px; overflow-y: auto; }
        .sidebar h3 { color: #8b949e; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        .messages { flex: 1; overflow-y: auto; padding: 16px 24px; }
        .message { margin-bottom: 16px; padding: 12px 16px; border-radius: 8px; max-width: 85%; white-space: pre-wrap; word-wrap: break-word; line-height: 1.5; font-size: 14px; }
        .message.user { background: #1f6feb; color: #fff; margin-left: auto; }
        .message.assistant { background: #21262d; border: 1px solid #30363d; }
        .message.tool { background: #0d1117; border: 1px solid #30363d; font-family: monospace; font-size: 12px; color: #8b949e; }
        .message.system { background: #0d1117; color: #8b949e; text-align: center; font-size: 13px; border: 1px dashed #30363d; }
        .thinking { color: #8b949e; font-style: italic; padding: 8px 24px; font-size: 13px; }
        .input-area { padding: 16px 24px; background: #161b22; border-top: 1px solid #30363d; display: flex; gap: 8px; }
        .input-area input { flex: 1; background: #0d1117; border: 1px solid #30363d; color: #c9d1d9; padding: 10px 16px; border-radius: 6px; font-size: 14px; outline: none; }
        .input-area input:focus { border-color: #58a6ff; }
        .input-area button { border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .btn-send { background: #238636; color: #fff; }
        .btn-send:hover { background: #2ea043; }
        .btn-send:disabled { background: #21262d; cursor: not-allowed; }
        .btn-voice { background: #1f6feb; color: #fff; padding: 10px 14px; }
        .btn-voice:hover { background: #388bfd; }
        .btn-voice.recording { background: #f85149; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-clear { background: #21262d; color: #8b949e; padding: 10px 14px; }
        .btn-clear:hover { background: #30363d; }
        .task-item { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 13px; }
        .task-item .name { color: #58a6ff; font-weight: 600; }
        .task-item .meta { color: #8b949e; font-size: 11px; margin-top: 4px; }
        .welcome { text-align: center; padding: 40px; color: #8b949e; }
        .welcome h2 { color: #58a6ff; margin-bottom: 8px; font-size: 24px; }
        .welcome p { font-size: 14px; line-height: 1.6; }
    </style>
</head>
<body>
    <header>
        <h1>BibsClaw</h1>
        <div class="status">
            <span class="provider-badge" id="providerBadge">--</span>
            <span class="status-dot inactive" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
        </div>
    </header>
    <main>
        <div class="chat-panel">
            <div class="messages" id="messages">
                <div class="welcome">
                    <h2>Welcome to BibsClaw</h2>
                    <p>Your personal AI assistant powered by Perplexity.<br>Type a message below or use the microphone to talk.</p>
                </div>
            </div>
            <div class="thinking" id="thinking" style="display:none">Thinking...</div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Type a message or command..." autocomplete="off">
                <button class="btn-voice" id="voiceBtn" title="Hold to speak">&#127908;</button>
                <button class="btn-clear" id="clearBtn" title="Clear history">&#128465;</button>
                <button class="btn-send" id="sendBtn">Send</button>
            </div>
        </div>
        <div class="sidebar">
            <h3>Scheduled Tasks</h3>
            <div id="taskList">No tasks yet</div>
            <h3>Tool Activity</h3>
            <div id="toolLog"></div>
        </div>
    </main>
    <script>
        const socket = io({ reconnection: true, reconnectionAttempts: 10, reconnectionDelay: 1000 });
        const messagesDiv = document.getElementById('messages');
        const thinkingDiv = document.getElementById('thinking');
        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const providerBadge = document.getElementById('providerBadge');
        const taskList = document.getElementById('taskList');
        const toolLog = document.getElementById('toolLog');

        function addMessage(role, text) {
            const welcome = messagesDiv.querySelector('.welcome');
            if (welcome) welcome.remove();
            const div = document.createElement('div');
            div.className = 'message ' + role;
            div.textContent = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const msg = input.value.trim();
            if (!msg) return;
            addMessage('user', msg);
            input.value = '';
            sendBtn.disabled = true;
            thinkingDiv.textContent = 'Thinking with Perplexity...';
            thinkingDiv.style.display = 'block';
            socket.emit('chat', msg);
        }

        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', () => {
            fetch('/api/history/clear', { method: 'POST' }).then(() => {
                messagesDiv.innerHTML = '<div class="message system">Conversation cleared</div>';
            });
        });

        // Voice input using browser Speech Recognition API (free, no API key needed)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'Listening... Click to stop';
                input.placeholder = 'Listening...';
            };

            recognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                input.value = transcript;
                if (event.results[event.results.length - 1].isFinal) {
                    sendMessage();
                }
            };

            recognition.onerror = (event) => {
                isListening = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'Click to speak';
                input.placeholder = 'Type a message or command...';
                if (event.error === 'not-allowed') {
                    addMessage('system', 'Microphone access denied. Please allow microphone permission.');
                } else if (event.error !== 'aborted') {
                    addMessage('system', 'Voice error: ' + event.error);
                }
            };

            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'Click to speak';
                input.placeholder = 'Type a message or command...';
            };
        }

        voiceBtn.addEventListener('click', () => {
            if (!SpeechRecognition) {
                addMessage('system', 'Speech recognition is not supported in this browser. Please use Chrome.');
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        socket.on('response', (text) => {
            addMessage('assistant', text);
            sendBtn.disabled = false;
            thinkingDiv.style.display = 'none';
        });

        socket.on('thinking', (isThinking) => {
            thinkingDiv.style.display = isThinking ? 'block' : 'none';
            if (!isThinking) sendBtn.disabled = false;
        });

        socket.on('agentThinking', (text) => {
            thinkingDiv.textContent = text;
            thinkingDiv.style.display = 'block';
        });

        socket.on('error', (errMsg) => {
            addMessage('system', 'Error: ' + errMsg);
            sendBtn.disabled = false;
            thinkingDiv.style.display = 'none';
        });

        socket.on('toolCall', (data) => {
            const div = document.createElement('div');
            div.className = 'message tool';
            div.textContent = 'Tool: ' + data.name;
            toolLog.prepend(div);
        });

        socket.on('toolResult', (data) => {
            const div = document.createElement('div');
            div.className = 'message tool';
            div.textContent = data.name + ': ' + (data.result.success ? 'OK' : 'FAIL');
            toolLog.prepend(div);
        });

        socket.on('taskRun', (task) => {
            const div = document.createElement('div');
            div.className = 'message tool';
            div.textContent = 'Task ran: ' + task.name;
            toolLog.prepend(div);
        });

        socket.on('connected', (data) => {
            providerBadge.textContent = (data.provider || 'AI').toUpperCase();
        });

        socket.on('disconnect', () => {
            statusDot.className = 'status-dot inactive';
            statusText.textContent = 'Disconnected';
        });

        socket.on('connect', () => {
            statusDot.className = 'status-dot active';
            statusText.textContent = 'Connected';
            fetch('/api/tasks').then(r => r.json()).then(tasks => {
                if (tasks.length === 0) return;
                taskList.innerHTML = '';
                tasks.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'task-item';
                    div.innerHTML = '<div class="name">' + t.name + '</div><div class="meta">' + t.cronExpression + ' | Runs: ' + t.runCount + '</div>';
                    taskList.appendChild(div);
                });
            }).catch(() => {});
        });
    </script>
</body>
</html>
